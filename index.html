<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Peta Kasus Per Desa</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; }
    .container {
      display: flex;
      flex-direction: row;
      height: 100vh;
    }
    #map {
      flex: 2;
      height: 100%;
    }
    .sidebar {
      flex: 1;
      padding: 10px;
      background: #f9f9f9;
      overflow-y: auto;
      box-shadow: -1px 0 5px rgba(0,0,0,0.1);
    }
    .filters {
      margin-bottom: 10px;
    }
    .filters label {
      display: block;
      margin: 5px 0;
    }
    select {
      width: 100%;
      padding: 5px;
    }
    #totalKasus {
      font-weight: bold;
      margin: 10px 0;
    }
    canvas {
      width: 100% !important;
      height: 200px !important;
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      .sidebar {
        order: -1;
        flex: none;
        width: 100%;
      }
      #map {
        flex: 1;
        height: 60vh;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div id="map"></div>
  <div class="sidebar">
    <div class="filters">
      <label>Tahun: <select id="filterTahun"></select></label>
      <label>Jenis Kasus: <select id="filterJenis"></select></label>
      <label>Kecamatan: <select id="filterKecamatan"><option value="">Semua</option></select></label>
      <label>Puskesmas: <select id="filterPuskesmas"><option value="">Semua</option></select></label>
    </div>
    <div id="totalKasus">Total Kasus: 0</div>
    <canvas id="chartKasus"></canvas>
  </div>
</div>

<script>
  const map = L.map('map').setView([-2.3, 115.6], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  let allLayers = {};
  let kasusData = {};
  let iddesaMap = {};
  let tahunList = [];

  const tahunSelect = document.getElementById("filterTahun");
  const jenisSelect = document.getElementById("filterJenis");
  const kecSelect = document.getElementById("filterKecamatan");
  const puskesmasSelect = document.getElementById("filterPuskesmas");
  const chartCtx = document.getElementById("chartKasus").getContext("2d");
  let chart = null;

  async function loadData() {
    const [csvRes, geoRes] = await Promise.all([
      fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSwQg9Qb96i2JjMBDBeuTKyl8fLDxm7a9cAMBMeVmDahfjRx_Kop9p4j-pG4SxT2bEyOXC3Ok9Wdp8s/pub?gid=564163547&single=true&output=csv'),
      fetch('https://untungnoer.github.io/balangan-map/Dsblg.geojson')
    ]);
    const csvText = await csvRes.text();
    const geojson = await geoRes.json();

    // Parse CSV
    const rows = csvText.trim().split("\n").slice(1).map(row => row.split(","));
    rows.forEach(([iddesa, kec, pusk, desa, tahun, jenis, jumlah]) => {
      if (!kasusData[iddesa]) kasusData[iddesa] = {};
      if (!kasusData[iddesa][tahun]) kasusData[iddesa][tahun] = {};
      kasusData[iddesa][tahun][jenis] = +jumlah;
      iddesaMap[iddesa] = { kecamatan: kec, Puskesmas: pusk, desa };
    });

    tahunList = [...new Set(rows.map(r => r[4]))].sort();
    tahunList.forEach(t => tahunSelect.innerHTML += `<option value="${t}">${t}</option>`);
    const jenisList = [...new Set(rows.map(r => r[5]))];
    jenisList.forEach(j => jenisSelect.innerHTML += `<option value="${j}">${j}</option>`);
    const kecList = [...new Set(rows.map(r => r[1]))];
    kecList.forEach(k => kecSelect.innerHTML += `<option value="${k}">${k}</option>`);

    geojson.features.forEach(feature => {
      const id = feature.properties.iddesa;
      const layer = L.geoJson(feature, {
        style: { color: "#999", weight: 1, fillOpacity: 0 }
      });
      allLayers[id] = layer;
    });

    Object.values(allLayers).forEach(l => l.addTo(map));

    kecSelect.addEventListener("change", () => {
      const kec = kecSelect.value;
      const filtered = rows.filter(r => !kec || r[1] === kec);
      const puskList = [...new Set(filtered.map(r => r[2]))];
      puskesmasSelect.innerHTML = `<option value="">Semua</option>`;
      puskList.forEach(p => puskesmasSelect.innerHTML += `<option value="${p}">${p}</option>`);
      updateMap();
    });

    [tahunSelect, jenisSelect, puskesmasSelect].forEach(el => el.addEventListener("change", updateMap));

    tahunSelect.selectedIndex = tahunList.length - 1;
    kecSelect.dispatchEvent(new Event('change'));
  }

  function updateMap() {
    const tahun = tahunSelect.value;
    const jenis = jenisSelect.value;
    const kecamatan = kecSelect.value;
    const puskesmas = puskesmasSelect.value;

    let total = 0;
    let matchingLayers = [];
    let yearlyTotals = {};

    tahunList.forEach(t => yearlyTotals[t] = 0);

    Object.entries(allLayers).forEach(([iddesa, layer]) => {
      const info = iddesaMap[iddesa];
      if (!info) return;

      const cocok = (!kecamatan || info.kecamatan === kecamatan) &&
                    (!puskesmas || info.Puskesmas === puskesmas);

      map.removeLayer(layer); // selalu remove

      if (cocok) {
        const jumlah = kasusData[iddesa]?.[tahun]?.[jenis] ?? 0;
        total += jumlah;

        tahunList.forEach(t => {
          yearlyTotals[t] += kasusData[iddesa]?.[t]?.[jenis] ?? 0;
        });

        const color = jumlah === 0 ? "#eee" :
                      jumlah < 5 ? "#fee08b" :
                      jumlah < 15 ? "#f46d43" : "#d73027";

        layer.setStyle({ fillColor: color, fillOpacity: 0.7 });
        layer.bindPopup(`<b>${info.desa}</b><br>Kecamatan: ${info.kecamatan}<br>${jenis} ${tahun}: ${jumlah}`);
        layer.addTo(map);
        matchingLayers.push(layer);
      } else {
        layer.closePopup();
      }
    });

    document.getElementById("totalKasus").innerHTML = `Total Kasus: <strong>${total}</strong>`;

    if (matchingLayers.length > 0) {
      const group = new L.featureGroup(matchingLayers.map(l => l.getLayers()[0]));
      map.fitBounds(group.getBounds().pad(0.2));
    }

    // Update chart
    const data = {
      labels: tahunList,
      datasets: [{
        label: jenis + " per Tahun",
        data: tahunList.map(t => yearlyTotals[t]),
        backgroundColor: '#4e79a7'
      }]
    };

    if (chart) {
      chart.data = data;
      chart.update();
    } else {
      chart = new Chart(chartCtx, {
        type: 'bar',
        data,
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: {
              label: ctx => `${ctx.raw} kasus`
            }}
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Jumlah Kasus' }},
            x: { title: { display: true, text: 'Tahun' }}
          }
        }
      });
    }
  }

  loadData();
</script>
</body>
</html>
