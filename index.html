<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Kasus Per Desa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 80vh; width: 100%; }

    .filter-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px;
      background: #f8f8f8;
    }

    .filter-panel label {
      flex: 1 1 45%;
      min-width: 150px;
    }

    @media (max-width: 600px) {
      .filter-panel label {
        flex: 1 1 100%;
      }
    }
  </style>
</head>
<body>
  <div class="filter-panel">
    <label>Kecamatan: <select id="filterKecamatan"></select></label>
    <label>Puskesmas: <select id="filterPuskesmas"></select></label>
    <label>Tahun: <select id="filterTahun"></select></label>
    <label>Jenis Kasus: <select id="filterJenis"></select></label>
    <span id="totalKasus" style="padding-top: 5px;"></span>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <script>
    let map = L.map('map').setView([-2.3, 115.6], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    let geojsonLayer;
    let kasusData = {};
    let iddesaMap = {};
    let kecPuskesmasMap = {};
    let geojsonFeatures = [];

    fetch("Dsblg.geojson")
      .then(res => res.json())
      .then(geojson => {
        geojsonFeatures = geojson.features;
        geojsonLayer = L.geoJSON(geojson, {
          style: { color: "#555", weight: 1, fillOpacity: 0.5 },
          onEachFeature: (feature, layer) => {
            layer.bindTooltip(`${feature.properties.desa}, ${feature.properties.kecamatan}`);
          }
        }).addTo(map);
        loadKasus();
      });

    function loadKasus() {
      Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vSwQg9Qb96i2JjMBDBeuTKyl8fLDxm7a9cAMBMeVmDahfjRx_Kop9p4j-pG4SxT2bEyOXC3Ok9Wdp8s/pub?gid=564163547&single=true&output=csv", {
        download: true,
        header: true,
        complete: function(results) {
          const rows = results.data;
          rows.forEach(row => {
            const id = row.iddesa;
            const tahun = row.Tahun;
            const jenis = row["Jenis Kasus"];
            const jumlah = parseInt(row.Jumlah) || 0;

            const kecamatan = row.kecamatan;
            const puskesmas = row.Puskesmas;
            const desa = row.desa;

            if (!iddesaMap[id]) {
              iddesaMap[id] = { kecamatan, puskesmas, desa };
            }

            if (!kasusData[id]) kasusData[id] = {};
            if (!kasusData[id][tahun]) kasusData[id][tahun] = {};
            kasusData[id][tahun][jenis] = jumlah;

            if (!kecPuskesmasMap[kecamatan]) kecPuskesmasMap[kecamatan] = new Set();
            kecPuskesmasMap[kecamatan].add(puskesmas);
          });

          isiFilter();
          updateMap();
        }
      });
    }

    function isiFilter() {
      const tahunSet = new Set();
      const jenisSet = new Set();
      const kecSet = new Set();

      for (let id in kasusData) {
        const info = iddesaMap[id];
        if (!info) continue;

        for (let tahun in kasusData[id]) {
          tahunSet.add(tahun);
          for (let jenis in kasusData[id][tahun]) {
            jenisSet.add(jenis);
          }
        }
        kecSet.add(info.kecamatan);
      }

      document.getElementById("filterTahun").innerHTML = [...tahunSet].sort().map(t => `<option value="${t}">${t}</option>`).join('');
      document.getElementById("filterJenis").innerHTML = [...jenisSet].sort().map(j => `<option value="${j}">${j}</option>`).join('');
      document.getElementById("filterKecamatan").innerHTML = ['<option value="">(Semua)</option>', ...[...kecSet].sort().map(k => `<option value="${k}">${k}</option>`)].join('');

      document.getElementById("filterKecamatan").onchange = updatePuskesmasOptions;
      document.getElementById("filterPuskesmas").onchange = updateMap;
      document.getElementById("filterTahun").onchange = updateMap;
      document.getElementById("filterJenis").onchange = updateMap;

      updatePuskesmasOptions();
    }

    function updatePuskesmasOptions() {
      const kecamatan = document.getElementById("filterKecamatan").value;
      let options = ['<option value="">(Semua)</option>'];

      if (kecamatan && kecPuskesmasMap[kecamatan]) {
        options.push(...[...kecPuskesmasMap[kecamatan]].sort().map(p => `<option value="${p}">${p}</option>`));
      }

      document.getElementById("filterPuskesmas").innerHTML = options.join('');
      updateMap();
    }

    function updateMap() {
      const tahun = document.getElementById("filterTahun").value;
      const jenis = document.getElementById("filterJenis").value;
      const kecamatan = document.getElementById("filterKecamatan").value;
      const puskesmas = document.getElementById("filterPuskesmas").value;

      let total = 0;
      let bounds = [];

      geojsonLayer.eachLayer(layer => {
        const id = layer.feature.properties.iddesa;
        const info = iddesaMap[id];
        if (!info) {
          layer.setStyle({ fillOpacity: 0 });
          layer.remove();
          return;
        }

        const jumlah = kasusData[id]?.[tahun]?.[jenis] ?? 0;

        if (
          (kecamatan && info.kecamatan !== kecamatan) ||
          (puskesmas && info.puskesmas !== puskesmas && puskesmas !== "")
        ) {
          map.removeLayer(layer);
          return;
        }

        total += jumlah;

        const color = jumlah === 0 ? "#eee" :
                      jumlah < 5 ? "#fee08b" :
                      jumlah < 15 ? "#f46d43" :
                      "#d73027";

        layer.setStyle({ fillColor: color, fillOpacity: 0.7 });
        layer.bindPopup(`<strong>${info.desa}</strong><br>Kecamatan: ${info.kecamatan}<br>${jenis} ${tahun}: ${jumlah}`);
        if (!map.hasLayer(layer)) geojsonLayer.addLayer(layer);

        bounds.push(layer.getBounds());
      });

      if (bounds.length) {
        const allBounds = bounds.reduce((a, b) => a.extend(b), bounds[0]);
        map.fitBounds(allBounds);
      }

      document.getElementById("totalKasus").innerHTML = `<strong>Total Kasus: ${total}</strong>`;
    }
  </script>
</body>
</html>
